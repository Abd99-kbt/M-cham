{% extends 'base.html' %}
{% load static %}

{% block title %}Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰: {{ original_message.subject }}{% endblock %}

{% block breadcrumb %}
{{ block.super }}
<li class="breadcrumb-item"><a href="{% url 'messaging:inbox' %}">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</a></li>
<li class="breadcrumb-item"><a href="{% url 'messaging:message_detail' original_message.message_id %}">Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ù„Ø©</a></li>
<li class="breadcrumb-item active">Ø±Ø¯</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h3 mb-0">
                <i class="fas fa-reply me-2 text-primary"></i>
                Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
            </h1>
        </div>
    </div>

    <!-- Reply Form -->
    <div class="card">
        <div class="card-body">
            <form method="post" action="{% url 'messaging:reply' original_message.message_id %}">
                {% csrf_token %}
                
                <!-- Subject -->
                <div class="mb-3">
                    <label for="id_subject" class="form-label fw-bold">Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹</label>
                    <input type="text" 
                           class="form-control" 
                           id="id_subject" 
                           name="subject" 
                           value="Ø±Ø¯: {{ original_message.subject }}"
                           required>
                </div>
                
                <!-- Body -->
                                    <div class="mb-3">
                    <label for="id_body" class="form-label fw-bold">Ù†Øµ Ø§Ù„Ø±Ø¯</label>
                    <div class="rich-text-editor-container">
                        <textarea class="form-control" 
                                  id="id_body" 
                                  name="body" 
                                  rows="8" 
                                  placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..."></textarea>
                    </div>
                    <div class="form-text mt-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span>
                                <i class="fas fa-info-circle me-1"></i>
                                ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
                            </span>
                            <span class="text-muted">
                                Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª: <span id="word-count">0</span> | 
                                Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø±Ù: <span id="body-count">0</span>
                            </span>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="d-flex justify-content-end">
                    <a href="{% url 'messaging:message_detail' original_message.message_id %}" class="btn btn-outline-secondary me-2">
                        Ø¥Ù„ØºØ§Ø¡
                    </a>
                    <button type="submit" id="submit-btn" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2" id="submit-icon"></i>
                        <span id="submit-text">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø¯</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Original Message -->
    <div class="card mt-4">
        <div class="card-header bg-light">
            <h5 class="mb-0">
                Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
            </h5>
        </div>
        <div class="card-body">
            <p><strong>Ù…Ù†:</strong> {{ original_message.sender.arabic_name }}</p>
            <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> {{ original_message.sent_at|date:"d/m/Y H:i" }}</p>
            <p><strong>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:</strong> {{ original_message.subject }}</p>
            <hr>
            <div class="message-body small">
                {{ original_message.body|safe }}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
/* ØªÙ†Ø³ÙŠÙ‚ Ù…Ø­Ø±Ø± Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ØºÙ†ÙŠ */
.rich-text-editor-container {
    position: relative;
}

.rich-text-editor-container .tox-tinymce {
    border-radius: 8px;
    border: 1px solid #dee2e6;
    box-shadow: 0 0 0 0.2rem rgba(30, 74, 107, 0.1);
}

.rich-text-editor-container .tox-toolbar {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.rich-text-editor-container .tox-edit-area {
    background-color: white;
}

/* Ø¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© */
.rich-text-editor-container .tox-edit-area__iframe {
    direction: rtl;
    text-align: right;
}

/* ØªØ®ØµÙŠØµ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª */
.rich-text-editor-container .tox-toolbar-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

/* Ø¥Ø¶Ø§ÙØ§Øª Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Bootstrap */
.rich-text-editor-container .tox {
    font-family: 'Tajawal', Arial, sans-serif;
}

#body-count, #word-count {
    font-weight: 600;
}

/* ØªÙ†Ø³ÙŠÙ‚ HTML Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© */
.message-body {
    direction: rtl;
    text-align: right;
    background: #f8f9fa;
    border-radius: 8px;
    padding: 1rem;
    margin: 1rem 0;
}

.message-body h1, .message-body h2, .message-body h3, 
.message-body h4, .message-body h5, .message-body h6 {
    color: #1e4a6b;
    margin-bottom: 0.5em;
    margin-top: 1em;
}

.message-body p {
    margin-bottom: 1em;
}

.message-body ul, .message-body ol {
    padding-right: 20px;
    margin-bottom: 1em;
}

.message-body table {
    width: 100%;
    border-collapse: collapse;
    margin: 1em 0;
}

.message-body table td, .message-body table th {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: right;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // ØªÙ‡ÙŠØ¦Ø© Ù…Ø­Ø±Ø± Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ØºÙ†ÙŠ TinyMCE Ù„Ù„Ø±Ø¯
    tinymce.init({
        selector: '#id_body',
        language: 'ar',
        directionality: 'rtl',
        height: 300,
        menubar: false,
        branding: false,
        promotion: false,
        
        // Ø§Ù„Ù€ plugins Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        plugins: [
            'lists', 'link', 'charmap', 'preview', 'searchreplace', 
            'visualblocks', 'code', 'fullscreen', 'insertdatetime', 
            'wordcount', 'emoticons', 'textcolor', 'colorpicker', 
            'textpattern', 'codesample', 'hr', 'directionality'
        ],
        
        // Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª Ù…Ø¨Ø³Ø· Ù„Ù„Ø±Ø¯
        toolbar: [
            'formatselect fontselect fontsizeselect',
            'bold italic underline strikethrough | forecolor backcolor | alignleft aligncenter alignright | ltr rtl',
            'bullist numlist | link emoticons charmap hr | searchreplace code fullscreen preview'
        ],
        
        // Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø®Ø·ÙˆØ·
        font_family_formats: 'Tajawal=Tajawal, Arial, sans-serif; Arial=arial,helvetica,sans-serif; Courier New=courier new,courier,monospace; Times New Roman=times new roman,times,serif;',
        
        // Ø£Ø­Ø¬Ø§Ù… Ø§Ù„Ø®Ø·ÙˆØ·
        fontsize_formats: '8pt 9pt 10pt 11pt 12pt 14pt 16pt 18pt 20pt 22pt 24pt 26pt 28pt 36pt 48pt 72pt',
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ØªÙˆÙ‰
        content_css: [
            'https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css',
            'https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap'
        ],
        
        content_style: `
            body { 
                font-family: 'Tajawal', Arial, sans-serif; 
                font-size: 14px; 
                direction: rtl; 
                text-align: right;
                line-height: 1.6;
                color: #333;
                background: white;
                padding: 15px;
            }
            h1, h2, h3, h4, h5, h6 { color: #1e4a6b; margin-bottom: 0.5em; }
            p { margin-bottom: 1em; }
            ul, ol { padding-right: 20px; }
        `,
        
        // Ø®ÙŠØ§Ø±Ø§Øª Ø£Ø®Ø±Ù‰
        paste_as_text: false,
        paste_merge_formats: true,
        smart_paste: true,
        
        // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù…Ø­Ø±Ø±
        setup: function(editor) {
            // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª ÙˆØ§Ù„Ø£Ø­Ø±Ù
            editor.on('keyup change', function() {
                const content = editor.getContent({ format: 'text' });
                const wordCount = content.trim() === '' ? 0 : content.trim().split(/\s+/).length;
                const charCount = content.length;
                
                $('#word-count').text(wordCount);
                $('#body-count').text(charCount);
                
                // ØªØ­Ø°ÙŠØ± Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ù†Øµ Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­
                if (charCount > 5000) {
                    $('#body-count').addClass('text-danger');
                } else {
                    $('#body-count').removeClass('text-danger');
                }
            });
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©
            editor.on('init', function() {
                editor.getDoc().dir = 'rtl';
                editor.getBody().style.direction = 'rtl';
                editor.getBody().style.textAlign = 'right';
            });
        },
        
        // Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„ØªØ­Ù‚Ù‚
        init_instance_callback: function(editor) {
            console.log('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù…Ø­Ø±Ø± Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ØºÙ†ÙŠ Ù„Ù„Ø±Ø¯ Ø¨Ù†Ø¬Ø§Ø­');
            // Ensure the editor is ready and force update of content on change
            editor.on('change keyup setcontent', function() {
                editor.save(); // This updates the original textarea
            });
        }
    });

    // Form validation
    $('form').on('submit', function(e) {
        console.log('ğŸ”„ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬...');
        
        // Force save all TinyMCE instances to their textareas
        if (typeof tinymce !== 'undefined') {
            tinymce.triggerSave();
        }
        
        const subject = $('#id_subject').val().trim();
        
        // Get content from TinyMCE or fallback to textarea
        let bodyContent = '';
        let bodyText = '';
        
        if (tinymce.get('id_body')) {
            console.log('ğŸ“ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† TinyMCE...');
            bodyContent = tinymce.get('id_body').getContent();
            bodyText = tinymce.get('id_body').getContent({format: 'text'});
            // Update the textarea with TinyMCE content before submission
            $('#id_body').val(bodyContent);
            console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« textarea Ø¨Ù…Ø­ØªÙˆÙ‰ TinyMCE');
        } else {
            console.log('ğŸ“ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† textarea Ù…Ø¨Ø§Ø´Ø±Ø©...');
            bodyContent = $('#id_body').val();
            bodyText = bodyContent;
        }
        
        console.log('ğŸ“‹ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:', subject);
        console.log('ğŸ“„ Ù†Øµ Ø§Ù„Ø±Ø¯:', bodyText.trim().substring(0, 50) + '...');
        
        if (!subject) {
            e.preventDefault();
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø±Ø¯');
            $('#id_subject').focus();
            return false;
        }
        
        if (!bodyText.trim()) {
            e.preventDefault();
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø±Ø¯');
            if (tinymce.get('id_body')) {
                tinymce.get('id_body').focus();
            } else {
                $('#id_body').focus();
            }
            return false;
        }
        
        console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
        
        // Show loading state
        $('#submit-btn').prop('disabled', true);
        $('#submit-icon').removeClass('fa-paper-plane').addClass('fa-spinner fa-spin');
        $('#submit-text').text('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
        
        return true;
    });
});
</script>
{% endblock %}
