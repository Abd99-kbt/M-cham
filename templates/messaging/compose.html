{% extends 'base.html' %}
{% load static %}

{% block title %}Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© - Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø±Ø§Ø³Ù„Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©{% endblock %}

{% block breadcrumb %}
{{ block.super }}
<li class="breadcrumb-item">
    <a href="{% url 'messaging:inbox' %}">Ø§Ù„Ø±Ø³Ø§Ø¦Ù„</a>
</li>
<li class="breadcrumb-item active">Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø©</li>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-edit me-2 text-primary"></i>
                        Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©
                    </h1>
                    <p class="text-muted mb-0">
                        Ø£Ø±Ø³Ù„ Ø±Ø³Ø§Ù„Ø© Ø¢Ù…Ù†Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¨Ù†Ùƒ
                    </p>
                </div>
                <div>
                    <a href="{% url 'messaging:inbox' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-right me-2"></i>
                        Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø³Ø§Ø¦Ù„
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Compose Form -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card compose-form">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-envelope me-2"></i>
                        Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" class="needs-validation auto-save" id="messageForm" novalidate>
                        {% csrf_token %}
                        
                        <!-- Recipients -->
                        <div class="mb-3">
                            <label for="id_recipients" class="form-label">
                                <i class="fas fa-users me-2"></i>
                                Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ÙˆÙ† <span class="text-danger">*</span>
                            </label>
                            <select class="form-select" 
                                    id="id_recipients" 
                                    name="recipients" 
                                    multiple 
                                    required
                                    size="4">
                                {% for user in users %}
                                <option value="{{ user.id }}">{{ user.arabic_name }} ({{ user.department.name }})</option>
                                {% endfor %}
                            </select>
                            <div class="invalid-feedback">
                                ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙ‚Ø¨Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
                            </div>
                            <div class="form-text">
                                Ø§Ø³ØªØ®Ø¯Ù… Ctrl + Click Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø© Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠÙ†
                                <div class="mt-2">
                                    <button type="button" class="btn btn-sm btn-outline-primary me-2" id="select-all-recipients">
                                        <i class="fas fa-check-square me-1"></i>
                                        Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙƒÙ„
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary" id="clear-recipients">
                                        <i class="fas fa-square me-1"></i>
                                        Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Subject -->
                        <div class="mb-3">
                            <label for="id_subject" class="form-label">
                                <i class="fas fa-heading me-2"></i>
                                Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ <span class="text-danger">*</span>
                            </label>
                            <input type="text" 
                                   class="form-control form-control-lg" 
                                   id="id_subject" 
                                   name="subject" 
                                   placeholder="Ø£Ø¯Ø®Ù„ Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©"
                                   required
                                   maxlength="200">
                            <div class="invalid-feedback">
                                ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                            </div>
                        </div>

                        <!-- Message Classification -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="id_category" class="form-label">
                                    <i class="fas fa-tags me-2"></i>
                                    Ø§Ù„ØªØµÙ†ÙŠÙ <span class="text-danger">*</span>
                                </label>
                                <select class="form-select" id="id_category" name="category" required>
                                    <option value="">Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ</option>
                                    {% for category in categories %}
                                    <option value="{{ category.id }}">{{ category.description }}</option>
                                    {% endfor %}
                                </select>
                                <div class="invalid-feedback">
                                    ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØµÙ†ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="id_priority" class="form-label">
                                    <i class="fas fa-exclamation-circle me-2"></i>
                                    Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©
                                </label>
                                <select class="form-select" id="id_priority" name="priority">
                                    <option value="NORMAL">Ø¹Ø§Ø¯ÙŠØ©</option>
                                    <option value="HIGH">Ù…Ù‡Ù…Ø©</option>
                                    <option value="URGENT">Ø¹Ø§Ø¬Ù„Ø©</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="id_confidentiality" class="form-label">
                                    <i class="fas fa-shield-alt me-2"></i>
                                    Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³Ø±ÙŠØ©
                                </label>
                                <select class="form-select" id="id_confidentiality" name="confidentiality">
                                    <option value="PUBLIC">Ø¹Ø§Ù…Ø©</option>
                                    <option value="INTERNAL">Ø¯Ø§Ø®Ù„ÙŠØ©</option>
                                    <option value="CONFIDENTIAL">Ø³Ø±ÙŠØ©</option>
                                    <option value="HIGHLY_CONFIDENTIAL">Ø³Ø±ÙŠØ© Ù„Ù„ØºØ§ÙŠØ©</option>
                                </select>
                            </div>
                        </div>

                        <!-- Message Body -->
                        <div class="mb-3">
                            <label for="id_body" class="form-label">
                                <i class="fas fa-align-left me-2"></i>
                                Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© <span class="text-danger">*</span>
                            </label>
                            <div class="rich-text-editor-container">
                                <!-- Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø±Ø± -->
                                <div id="editor-loading" class="alert alert-info" style="display: none;">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ø±Ø± Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…...
                                </div>
                                
                                <!-- Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
                                <div id="editor-error" class="alert alert-warning" style="display: none;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>ØªÙ†Ø¨ÙŠÙ‡:</strong> Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ø±Ø± Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…ØªÙ‚Ø¯Ù…. 
                                    <div class="mt-2">
                                        <button type="button" class="btn btn-sm btn-outline-primary ms-1" onclick="location.reload()">
                                            <i class="fas fa-refresh"></i> Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary ms-1" id="retry-editor">
                                            <i class="fas fa-redo"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
                                        </button>
                                        <a href="/messaging/debug-tinymce/" target="_blank" class="btn btn-sm btn-outline-info ms-1">
                                            <i class="fas fa-bug"></i> ØªØ´Ø®ÙŠØµ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
                                        </a>
                                    </div>
                                    <small class="mt-2 d-block">
                                        ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ø³ØªÙ…Ø±Ø§Ø± ÙÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø­Ø±Ø± Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø¨Ø³ÙŠØ· Ø£Ùˆ 
                                        <a href="/messaging/debug-tinymce/" target="_blank">ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ</a> Ù„Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©.
                                    </small>
                                </div>
                                
                                <!-- Ø±Ø³Ø§Ù„Ø© Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ­Ù…ÙŠÙ„ -->
                                <div id="editor-success" class="alert alert-success" style="display: none;">
                                    <i class="fas fa-check-circle me-2"></i>
                                    ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø­Ø±Ø± Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…ØªÙ‚Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­!
                                </div>
                                
                                <textarea class="form-control" 
                                          id="id_body" 
                                          name="body" 
                                          rows="12" 
                                          placeholder="Ø§ÙƒØªØ¨ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§..."
                                          required></textarea>
                            </div>
                            <div class="invalid-feedback">
                                ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                            </div>
                            <div class="form-text mt-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <span>
                                        <i class="fas fa-info-circle me-1"></i>
                                        ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù†Øµ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
                                    </span>
                                    <span class="text-muted">
                                        Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª: <span id="word-count">0</span> | 
                                        Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø­Ø±Ù: <span id="body-count">0</span>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Attachments -->
                        <div class="mb-3">
                            <label for="id_attachments" class="form-label">
                                <i class="fas fa-paperclip me-2"></i>
                                Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª
                            </label>
                            <input type="file" 
                                   class="form-control file-upload" 
                                   id="id_attachments" 
                                   name="attachments" 
                                   multiple
                                   accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.jpg,.png">
                            <div class="form-text">
                                ÙŠÙ…ÙƒÙ†Ùƒ Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø¨Ø­Ø¬Ù… Ø£Ù‚ØµÙ‰ 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª Ù„ÙƒÙ„ Ù…Ù„Ù. Ø§Ù„Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ù…Ø¯Ø¹ÙˆÙ…Ø©: PDF, Word, Excel, ØµÙˆØ±
                            </div>
                            <div class="file-preview mt-2"></div>
                        </div>

                        <!-- Security Options -->
                        <div class="card bg-light mb-3">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="fas fa-lock me-2"></i>
                                    Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†
                                </h6>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" 
                                                   type="checkbox" 
                                                   id="id_prevent_forwarding" 
                                                   name="prevent_forwarding">
                                            <label class="form-check-label" for="id_prevent_forwarding">
                                                Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" 
                                                   type="checkbox" 
                                                   id="id_require_confirmation" 
                                                   name="require_confirmation">
                                            <label class="form-check-label" for="id_require_confirmation">
                                                Ø·Ù„Ø¨ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©
                                            </label>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-check">
                                            <input class="form-check-input" 
                                                   type="checkbox" 
                                                   id="id_digital_signature" 
                                                   name="digital_signature">
                                            <label class="form-check-label" for="id_digital_signature">
                                                ØªÙˆÙ‚ÙŠØ¹ Ø±Ù‚Ù…ÙŠ
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" 
                                                   type="checkbox" 
                                                   id="id_auto_delete" 
                                                   name="auto_delete">
                                            <label class="form-check-label" for="id_auto_delete">
                                                Ø­Ø°Ù ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ 30 ÙŠÙˆÙ…Ø§Ù‹
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between">
                            <div>
                                <button type="submit" name="action" value="send" class="btn btn-primary btn-lg btn-send">
                                    <i class="fas fa-paper-plane me-2"></i>
                                    Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
                                </button>
                                <button type="submit" name="action" value="draft" class="btn btn-outline-secondary btn-save ms-2">
                                    <i class="fas fa-save me-2"></i>
                                    Ø­ÙØ¸ ÙƒÙ…Ø³ÙˆØ¯Ø©
                                </button>
                            </div>
                            <div class="draft-status text-muted small"></div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Recipients -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-star me-2"></i>
                        Ù…Ø³ØªÙ„Ù…ÙˆÙ† Ù…ÙØ¶Ù„ÙˆÙ†
                    </h6>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action border-0 px-0 py-2 quick-recipient">
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-2">
                                    <i class="fas fa-user-circle text-primary"></i>
                                </div>
                                <div>
                                    <div class="fw-bold">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</div>
                                    <small class="text-muted">Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©</small>
                                </div>
                            </div>
                        </a>
                        <a href="#" class="list-group-item list-group-item-action border-0 px-0 py-2 quick-recipient">
                            <div class="d-flex align-items-center">
                                <div class="user-avatar me-2">
                                    <i class="fas fa-user-circle text-success"></i>
                                </div>
                                <div>
                                    <div class="fw-bold">Ù…Ø¯ÙŠØ± ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
                                    <small class="text-muted">ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</small>
                                </div>
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Message Templates -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-file-alt me-2"></i>
                        Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                    </h6>
                </div>
                <div class="card-body">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item list-group-item-action border-0 px-0 py-2 message-template" 
                           data-subject="Ø·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚Ø©" 
                           data-body="ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù†Ø¸Ø± ÙÙŠ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø±ÙÙ‚ ÙˆØ§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„ÙŠÙ‡.">
                            <i class="fas fa-check-circle me-2 text-success"></i>
                            Ø·Ù„Ø¨ Ù…ÙˆØ§ÙÙ‚Ø©
                        </a>
                        <a href="#" class="list-group-item list-group-item-action border-0 px-0 py-2 message-template"
                           data-subject="ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ"
                           data-body="ÙŠØ´Ø±ÙÙ†ÙŠ Ø£Ù† Ø£Ø±ÙØ¹ Ù„Ø³ÙŠØ§Ø¯ØªÙƒÙ… Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù„ÙØªØ±Ø©...">
                            <i class="fas fa-chart-line me-2 text-info"></i>
                            ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ
                        </a>
                        <a href="#" class="list-group-item list-group-item-action border-0 px-0 py-2 message-template"
                           data-subject="Ø§Ø¬ØªÙ…Ø§Ø¹ Ø¹Ø§Ø¬Ù„"
                           data-body="Ù†Ø±Ø¬Ùˆ Ø­Ø¶ÙˆØ±ÙƒÙ… Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ Ø¹Ø§Ø¬Ù„ ÙÙŠ...">
                            <i class="fas fa-calendar-alt me-2 text-warning"></i>
                            Ø¯Ø¹ÙˆØ© Ø§Ø¬ØªÙ…Ø§Ø¹
                        </a>
                    </div>
                </div>
            </div>

            <!-- Security Tips -->
            <div class="card">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-lightbulb me-2"></i>
                        Ù†ØµØ§Ø¦Ø­ Ø£Ù…Ù†ÙŠØ©
                    </h6>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled mb-0">
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø±Ø³Ø§Ù„Ø©
                        </li>
                        <li class="mb-2">
                            <i class="fas fa-check text-success me-2"></i>
                            ÙØ¹Ù„ Ø§Ù„Ø­Ø°Ù Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø­Ø³Ø§Ø³Ø©
                        </li>
                        <li class="mb-0">
                            <i class="fas fa-check text-success me-2"></i>
                            Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø±Ù‚Ù…ÙŠ Ù„Ù„Ù…Ø³ØªÙ†Ø¯Ø§Øª Ø§Ù„Ù…Ù‡Ù…Ø©
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recipients Modal -->
<div class="modal fade" id="recipientsModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-address-book me-2"></i>
                    Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Search -->
                <div class="mb-3">
                    <input type="text" 
                           class="form-control search-input" 
                           placeholder="Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†..."
                           data-target="recipients">
                </div>
                
                <!-- Departments -->
                <div class="accordion" id="departmentsAccordion">
                    <div class="accordion-item">
                        <h6 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#dept1">
                                <i class="fas fa-building me-2"></i>
                                Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
                            </button>
                        </h6>
                        <div id="dept1" class="accordion-collapse collapse show" data-bs-parent="#departmentsAccordion">
                            <div class="accordion-body">
                                <div class="form-check">
                                    <input class="form-check-input recipient-checkbox" type="checkbox" id="user1" value="admin">
                                    <label class="form-check-label" for="user1">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user-circle me-2 text-primary"></i>
                                            <div>
                                                <div class="fw-bold">Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</div>
                                                <small class="text-muted">admin@bank.com</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h6 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#dept2">
                                <i class="fas fa-laptop me-2"></i>
                                ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                            </button>
                        </h6>
                        <div id="dept2" class="accordion-collapse collapse" data-bs-parent="#departmentsAccordion">
                            <div class="accordion-body">
                                <div class="form-check">
                                    <input class="form-check-input recipient-checkbox" type="checkbox" id="user2" value="itmanager">
                                    <label class="form-check-label" for="user2">
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user-circle me-2 text-success"></i>
                                            <div>
                                                <div class="fw-bold">Ù…Ø¯ÙŠØ± ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</div>
                                                <small class="text-muted">itmanager@bank.com</small>
                                            </div>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="me-auto">
                    <small class="text-muted">ØªÙ… Ø§Ø®ØªÙŠØ§Ø± <span id="selected-count">0</span> Ù…Ø³ØªÙ„Ù…</small>
                </div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                <button type="button" class="btn btn-primary" id="addRecipients">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.compose-form {
    background: white;
    border-radius: var(--border-radius);
    box-shadow: var(--box-shadow);
}

.user-avatar {
    width: 35px;
    height: 35px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
}

.quick-recipient:hover,
.message-template:hover {
    background-color: rgba(30, 74, 107, 0.05);
}

.file-preview .attachment-item {
    background-color: var(--light-color);
    border-radius: var(--border-radius);
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.form-control:focus,
.form-select:focus {
    border-color: var(--primary-color);
    box-shadow: 0 0 0 0.2rem rgba(30, 74, 107, 0.25);
}

.recipient-checkbox:checked + label {
    background-color: rgba(30, 74, 107, 0.1);
    border-radius: var(--border-radius);
    padding: 0.5rem;
}

#body-count, #word-count {
    font-weight: 600;
}

.draft-status {
    display: flex;
    align-items: center;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ù…Ø­Ø±Ø± Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ØºÙ†ÙŠ */
.rich-text-editor-container {
    position: relative;
}

.rich-text-editor-container .tox-tinymce {
    border-radius: 8px;
    border: 1px solid #dee2e6;
    box-shadow: 0 0 0 0.2rem rgba(30, 74, 107, 0.1);
}

.rich-text-editor-container .tox-toolbar {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.rich-text-editor-container .tox-edit-area {
    background-color: white;
}

/* Ø¯Ø¹Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© */
.rich-text-editor-container .tox-edit-area__iframe {
    direction: rtl;
    text-align: right;
}

/* ØªØ®ØµÙŠØµ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª */
.rich-text-editor-container .tox-toolbar-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
}

.rich-text-editor-container .tox-toolbar__group {
    border-color: #dee2e6;
}

/* ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
.rich-text-editor-container .tox-tbtn {
    border-radius: 4px;
    margin: 1px;
}

.rich-text-editor-container .tox-tbtn:hover {
    background-color: rgba(30, 74, 107, 0.1);
}

.rich-text-editor-container .tox-tbtn--enabled {
    background-color: rgba(30, 74, 107, 0.2);
}

/* ØªØ­Ø³ÙŠÙ† Ø´Ø±ÙŠØ· Ø§Ù„Ø­Ø§Ù„Ø© */
.rich-text-editor-container .tox-statusbar {
    background-color: #f8f9fa;
    border-top: 1px solid #dee2e6;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© */
.rich-text-editor-container .tox-collection__item {
    direction: rtl;
    text-align: right;
}

/* ØªØ­Ø³ÙŠÙ† Ù†Ø§ÙØ°Ø© Ø§Ù„Ø­ÙˆØ§Ø± */
.tox-dialog {
    direction: rtl;
}

.tox-dialog__body {
    direction: rtl;
    text-align: right;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ù„Ù€ fullscreen mode */
.tox-fullscreen .tox-edit-area__iframe {
    direction: rtl;
    text-align: right;
}

/* Ø¥Ø¶Ø§ÙØ§Øª Ù„Ù„ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Bootstrap */
.rich-text-editor-container .tox {
    font-family: 'Tajawal', Arial, sans-serif;
}
</style>
{% endblock %}

{% block extra_js %}
<!-- ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„ØªØ´Ø®ÙŠØµ -->
<script src="{% static 'js/tinymce-debug.js' %}"></script>
<script>
$(document).ready(function() {
    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
    $('#editor-loading').show();
    
    // Ø§Ù†ØªØ¸Ø§Ø± ØªØ­Ù…ÙŠÙ„ TinyMCE Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
    function initTinyMCE() {
        // ØªØ­Ù‚Ù‚ Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Ø­Ù„ Ù…Ù† TinyMCE
        if (typeof tinymce === 'undefined') {
            console.error('âŒ TinyMCE ØºÙŠØ± Ù…ØªØ§Ø­ - ÙØ´Ù„ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„');
            $('#editor-loading').hide();
            $('#editor-error').show();
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†
            setTimeout(function() {
                $('#editor-error').fadeOut();
            }, 10000);
            return false;
        }

        // ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† TinyMCE Ù…Ø­Ù…Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        if (!tinymce.init) {
            console.warn('âš ï¸ TinyMCE Ù…Ø­Ù…Ù„ Ø¬Ø²Ø¦ÙŠØ§Ù‹ - Ø§Ù†ØªØ¸Ø§Ø±...');
            setTimeout(initTinyMCE, 500);
            return false;
        }

        console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªÙ‡ÙŠØ¦Ø© Ù…Ø­Ø±Ø± Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ØºÙ†ÙŠ TinyMCE');
        $('#editor-loading').hide();
        
        // ØªÙ‡ÙŠØ¦Ø© Ù…Ø­Ø±Ø± Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ØºÙ†ÙŠ TinyMCE (ØªÙƒÙˆÙŠÙ† Ù…Ø¨Ø³Ø·)
        var config = {
            selector: '#id_body',
            language: 'ar',
            directionality: 'rtl',
            height: 400,
            menubar: false,
            branding: false,
            promotion: false,
            statusbar: true,
            resize: true,
            
            // Ø§Ù„Ù€ plugins Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·
            plugins: [
                'lists', 'link', 'charmap', 'preview', 'searchreplace', 
                'visualblocks', 'code', 'fullscreen', 'wordcount', 
                'emoticons', 'directionality', 'table'
            ],
            
            // Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª Ù…Ø¨Ø³Ø·
            toolbar: 'undo redo | formatselect | bold italic underline | alignleft aligncenter alignright | ltr rtl | bullist numlist | link | fullscreen preview',
            
            // ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            block_formats: 'ÙÙ‚Ø±Ø©=p; Ø¹Ù†ÙˆØ§Ù† 1=h1; Ø¹Ù†ÙˆØ§Ù† 2=h2; Ø¹Ù†ÙˆØ§Ù† 3=h3; Ø§Ù‚ØªØ¨Ø§Ø³=blockquote',
            
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø¨Ø³Ø·Ø©
            content_style: 'body { font-family: Arial, sans-serif; font-size: 14px; direction: rtl; text-align: right; }',
            
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø­Ø±Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
            setup: function(editor) {
                editor.on('init', function() {
                    console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù…Ø­Ø±Ø± Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„ØºÙ†ÙŠ Ø¨Ù†Ø¬Ø§Ø­');
                    editor.getDoc().dir = 'rtl';
                    editor.getBody().style.direction = 'rtl';
                    editor.getBody().style.textAlign = 'right';
                    
                    // Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­
                    $('#editor-success').show();
                    setTimeout(function() {
                        $('#editor-success').fadeOut();
                    }, 3000);
                });
            }
        };
        
        // ØªÙ‡ÙŠØ¦Ø© TinyMCE Ù…Ø¹ Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡
        try {
            tinymce.init(config);
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© TinyMCE:', error);
            $('#editor-loading').hide();
            $('#editor-error').show();
        }
        
        return true;
    }

    // Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
    $('#retry-editor').on('click', function() {
        $('#editor-error').hide();
        $('#editor-loading').show();
        
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ TinyMCE
        setTimeout(function() {
            tryInitTinyMCE(1);
        }, 500);
    });

    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø­Ø±Ø± Ù…Ø¹ ÙØªØ±Ø§Øª Ø§Ù†ØªØ¸Ø§Ø± Ù…ØªØ¯Ø±Ø¬Ø©
    function tryInitTinyMCE(attempt) {
        attempt = attempt || 1;
        console.log(`ğŸ”„ Ù…Ø­Ø§ÙˆÙ„Ø© ${attempt} Ù„ØªÙ‡ÙŠØ¦Ø© TinyMCE`);
        
        if (initTinyMCE()) {
            console.log('âœ… ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø­Ø±Ø± Ø¨Ù†Ø¬Ø§Ø­');
            return;
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ø­ØªÙ‰ 5 Ù…Ø±Ø§Øª
        if (attempt < 5) {
            setTimeout(function() {
                tryInitTinyMCE(attempt + 1);
            }, attempt * 1000); // Ø²ÙŠØ§Ø¯Ø© ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù…Ø¹ ÙƒÙ„ Ù…Ø­Ø§ÙˆÙ„Ø©
        } else {
            console.error('âŒ ÙØ´Ù„ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© TinyMCE Ø¨Ø¹Ø¯ 5 Ù…Ø­Ø§ÙˆÙ„Ø§Øª');
            $('#editor-loading').hide();
            $('#editor-error').show();
        }
    }
    
    // Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
    setTimeout(tryInitTinyMCE, 500);

    // Character counter for message body (fallback for non-TinyMCE)
    $('#id_body').on('input', function() {
        if (!tinymce.get('id_body')) {
            const count = $(this).val().length;
            $('#body-count').text(count);
            
            if (count > 5000) {
                $('#body-count').addClass('text-danger');
            } else {
                $('#body-count').removeClass('text-danger');
            }
        }
    });

    // Recipients management with new select field
    $('#select-all-recipients').on('click', function(e) {
        e.preventDefault();
        $('#id_recipients option').prop('selected', true);
    });

    $('#clear-recipients').on('click', function(e) {
        e.preventDefault();
        $('#id_recipients option').prop('selected', false);
    });

    // Quick recipients from sidebar (now works with select field)
    $('.quick-recipient').on('click', function(e) {
        e.preventDefault();
        const userId = $(this).data('user-id');
        if (userId) {
            $(`#id_recipients option[value="${userId}"]`).prop('selected', true);
        }
    });

    // Message templates - Enhanced for TinyMCE
    $('.message-template').on('click', function(e) {
        e.preventDefault();
        const subject = $(this).data('subject');
        const body = $(this).data('body');
        
        $('#id_subject').val(subject);
        
        // Set content in TinyMCE if available, otherwise use textarea
        if (tinymce.get('id_body')) {
            tinymce.get('id_body').setContent(body);
            // Trigger change event to update character count
            tinymce.get('id_body').fire('change');
        } else {
            $('#id_body').val(body);
            $('#id_body').trigger('input'); // Update character count
        }
    });

    // Recipients modal
    $('.recipient-checkbox').on('change', function() {
        updateSelectedCount();
    });

    function updateSelectedCount() {
        const count = $('.recipient-checkbox:checked').length;
        $('#selected-count').text(count);
    }

    $('#addRecipients').on('click', function() {
        const selectedUsers = [];
        $('.recipient-checkbox:checked').each(function() {
            const label = $(this).siblings('label').find('.fw-bold').text();
            selectedUsers.push(label);
        });
        
        if (selectedUsers.length > 0) {
            const currentTo = $('#id_to').val();
            if (currentTo) {
                $('#id_to').val(currentTo + ', ' + selectedUsers.join(', '));
            } else {
                $('#id_to').val(selectedUsers.join(', '));
            }
            
            $('#recipientsModal').modal('hide');
        }
    });

    // Priority and confidentiality warnings
    $('#id_priority').on('change', function() {
        if ($(this).val() === 'URGENT') {
            showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ø£ÙˆÙ„ÙˆÙŠØ© Ø¹Ø§Ø¬Ù„Ø©. Ø³ØªØµÙ„ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ÙÙˆØ±ÙŠØ© Ù„Ù„Ù…Ø³ØªÙ„Ù…ÙŠÙ†.', 'warning');
        }
    });

    $('#id_confidentiality').on('change', function() {
        if ($(this).val() === 'HIGHLY_CONFIDENTIAL') {
            showAlert('ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…Ø³ØªÙˆÙ‰ Ø³Ø±ÙŠØ© Ø¹Ø§Ù„ÙŠ. Ø³ÙŠØªÙ… Ù…Ù†Ø¹ Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.', 'info');
            $('#id_prevent_forwarding').prop('checked', true);
        }
    });

    // Form validation enhancements
    $('.needs-validation').on('submit', function(e) {
        // Get content from TinyMCE
        const bodyContent = tinymce.get('id_body') ? tinymce.get('id_body').getContent() : $('#id_body').val();
        const bodyText = tinymce.get('id_body') ? tinymce.get('id_body').getContent({format: 'text'}) : $('#id_body').val();
        
        // Check if recipients are selected
        const recipients = $('#id_recipients').val();
        if (!recipients || recipients.length === 0) {
            e.preventDefault();
            e.stopPropagation();
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙ‚Ø¨Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
            $('#id_recipients').focus();
            return false;
        }

        // Check message length
        if (bodyText.length > 5000) {
            e.preventDefault();
            e.stopPropagation();
            alert('Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹. Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 5000 Ø­Ø±Ù.');
            if (tinymce.get('id_body')) {
                tinymce.get('id_body').focus();
            } else {
                $('#id_body').focus();
            }
            return false;
        }

        // Check if message body is empty
        if (!bodyText.trim()) {
            e.preventDefault();
            e.stopPropagation();
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
            if (tinymce.get('id_body')) {
                tinymce.get('id_body').focus();
            } else {
                $('#id_body').focus();
            }
            return false;
        }

        // Show loading state
        const submitBtn = $('.btn-send');
        const originalText = submitBtn.html();
        submitBtn.html('<i class="fas fa-spinner fa-spin me-2"></i>Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...');
        submitBtn.prop('disabled', true);
        
        // Restore button if form submission fails
        setTimeout(() => {
            submitBtn.html(originalText);
            submitBtn.prop('disabled', false);
        }, 10000);
    });

    // Enhanced Form validation for TinyMCE
    $('#messageForm').on('submit', function(e) {
        const recipients = $('#id_recipients').val();
        const subject = $('#id_subject').val().trim();
        
        // Get content from TinyMCE or fallback to textarea
        let bodyContent = '';
        let bodyText = '';
        
        if (tinymce.get('id_body')) {
            bodyContent = tinymce.get('id_body').getContent();
            bodyText = tinymce.get('id_body').getContent({format: 'text'});
            // Update the textarea with TinyMCE content before submission
            $('#id_body').val(bodyContent);
        } else {
            bodyContent = $('#id_body').val();
            bodyText = bodyContent;
        }
        
        if (!recipients || recipients.length === 0) {
            e.preventDefault();
            alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø³ØªÙ‚Ø¨Ù„ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„');
            $('#id_recipients').focus();
            return false;
        }
        
        if (!subject) {
            e.preventDefault();
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
            $('#id_subject').focus();
            return false;
        }
        
        if (!bodyText.trim()) {
            e.preventDefault();
            alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù†Øµ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
            if (tinymce.get('id_body')) {
                tinymce.get('id_body').focus();
            } else {
                $('#id_body').focus();
            }
            return false;
        }
        
        return true;
    });

    // Auto-save functionality is handled by main.js
});
</script>
{% endblock %}